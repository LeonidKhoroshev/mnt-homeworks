# Домашнее задание к занятию 17 «Инцидент-менеджмент» - Леонид Хорошев

## Задание

Составьте постмортем на основе реального сбоя системы GitHub в 2018 году.

Информацию о сбое можно изучить по ссылкам ниже:

* [краткое описание на русском языке](https://habr.com/ru/post/427301/);
* [развёрнутое описание на английском языке](https://github.blog/2018-10-30-oct21-post-incident-analysis/).



### Краткое описание инцидента
 
21.10.2018 в 22:52 на `GitHub.com` зафиксирован сбой базы данных, что привело к некорректному отображению информации на сайте, потере части данных и отсутствию возможности создавать `GitHub Pages` и обслуживать вебхук (технология оповещения о новых событиях на сервере).

### Причина

Кратковременная потеря связи (43 секунды) между Центром обработки данных и сетевым центром (оба центра расположены на Восточном побережье США).

### Таймлайн (хронология событий)

#### 21.10.2018, 22:52 UTC 
Во время разделения сети  дата-центр Западного побережья и узлы Orchestrator публичного облака на Восточном побережье начали отработку отказа кластеров для направления записей в западный дата-центр. Orchestrator начал создавать топологию кластера БД на Западе, а после восстановления подключения приложения направили трафик на новые основные серверы в US West. В восточном дата-центре остались записи, которые не реплицировались, и следовательно, кластеры обной БД в обоих ЦОД теперь содержали записи, которых не было в другом ЦОД.

#### 21.10.2018, 22:54 UTC
Cистемы мониторинга GitHub начали генерировать оповещения, указывающие на многочисленные сбои в работе систем.

#### 21.10.2018, 23:02 UTC
Инженеры первой группы реагирования определили, что топологии для многочисленных кластеров БД находятся в неожиданном состоянии. При запросе API Orchestrator отображалась топология репликации БД, содержащая только серверы из западного ЦОД.

#### 21.10.2018, 23:07 UTC
Группа реагирования решила вручную заблокировать внутренние средства развёртывания, чтобы предотвратить внесение дополнительных изменений. 

#### 21.10.2018, 23:09 UTC
Установлен жёлтый статус работоспособности сайта. Это действие отправило предупреждение координатору инцидентов. 

#### 21.10.2018, 23:11 UTC
Статус  работоспособности сайта изменен на красный.

#### 21.10.2018, 23:13 UTC
Установлено, что проблема затрагивает несколько кластеров БД. Начато исследование текущего состояния в целях определения необходимых первоочередных действия для ручной настройки БД Восточного побережья США в качестве основной для каждого кластера и перестройки топологии репликации. Исходя из требований к конфиденциальности и целостности пользовательских данных принято решение о переносе вперед (failing-forward). Данное решение позволило обеспечить согласованность данных пользователей (без их утери), однако также повлекло за собой деградацию качества обслуживание и сбои в работе сервисов. Причина -  приложения на востоке, зависящие от записи информации в западный кластер MySQL были неспособны справиться с дополнительной задержкой из-за передачи большинства их вызовов БД туда и обратно.

#### 21.10.2018, 23:19 UTC
Анализ состояния кластеров БД показал необходимость остановки выполнения заданий, пишущих метаданные типа пуш-запросов. Команда Github сознательно пошла на частичную деградацию сервиса, приостановив вебхуки и сборку GitHub Pages, чтобы не ставить под угрозу пользовательские данные. Выбрана стратегия приоритетности целостности данных вместо над удобством использования сайта и быстрого восстановления.

#### 22.10.2018, 00:05 UTC
Начата разработка плана устранения несогласованности данных, запущена процедура отработки отказа для MySQL. Планировалось восстановить файлы из бэкапа, синхронизировать реплики, вернуться к стабильной топологии обслуживания, а затем возобновить обработку заданий в очереди. Восстановление нескольких терабайт из бэкапа заняло несколько часов. Долго шла передача данных из службы удалённого резервного копирования. Основная часть времени ушла на процесс распаковки, проверки контрольной суммы, подготовки и загрузки больших файлов бэкапа на свежеподготовленные серверы MySQL.

#### 22.10.2018, 00:41 UTC
Инициирован процесс резервного копирования для всех затронутых кластеров MySQL, организовано отслеживание прогресса и проработка возможности ускорения передачи и восстановления БД без дальнейшей деградации сайта или риска повреждения данных.

#### 22.10.2018, 06:51 UTC
В ряде кластеров в восточном ЦОД завершен процесс восстановления из резервных копий и начато реплицирование новых данных с Западным побережьем. Это привело к замедлению загрузки страниц, которые выполняли операцию записи, но чтение страниц из этих кластеров БД возвращало актуальные результаты. Параллельно командой GitHub определен способ восстановления непосредственно с Западного побережья, чтобы минимизировать эффект от ограничения пропускной способности, вызванного загрузкой из внешнего хранилища.

#### 22.10.2018, 07:46 UTC
Опубликовано информационное сообщение в блоге [GitHub](https://github.blog/2018-10-21-october21-incident-report/).

#### 22.10.2018, 11:12 UTC
Все первичные БД вновь переведены на Восток. Cайт стал более отзывчивым, существенно повышена производительность, однако часть реплик еще отстаёт от основной копии на несколько часов, из-за чего пользователи видели несогласованные данные при взаимодействии со службами GitHub. 

#### 22.10.2018, 13:15 UTC
В команде реагирования проведено обсуждение дальнейших действий, выявлено, что отставание репликации до согласованного состояния увеличивается, а не уменьшается. Так как ранее была начата подготовка дополнительных реплик, то как только они стали доступны, поток запросов на чтение был дополнительно перераспределен  между несколькими серверами. Уменьшение средней нагрузки на реплики чтения ускорило догон репликации.

#### 22.10.2018, 16:24 UTC
После синхронизации реплик произошел возврат к исходной топологии. В рамках исполнения решения о приоритете целостности данных над быстрым исправлением ситуации красный статус сайта сохранен.

#### 22.10.2018, 16:45 UTC
На этапе восстановления необходимо сбалансировать возросшую нагрузку, связанную с отставанием. В очереди оставалось более 5 млн событий хуков и 80 тыс. запросов на построение веб-страниц.
Когда команда GitHub повторно включила обработку данных, было обработано около 200 тыс. полезных задач с вебхуками, которые превысили внутренний TTL и были отброшены. Узнав об этом, команда GitHub остановила обработку и запушила увеличение TTL (чтобы задачи не отбрасывались из-за временнных лимитов). Во избежание дальнейшего снижения надёжности, статус деградации доставлен до полного завершия обработки накопившегося объёма данных.

#### №22.10.2018, 23:03 UTC
Все незавершённые события вебхуков и сборки Pages обработаны, целостность и правильная работа всех систем подтверждена. Статус сайта обновлён на зелёный.

